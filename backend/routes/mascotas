import logging
from flask import Blueprint, request, jsonify
from flask_cors import CORS  # ‚úÖ Permitir solicitudes del frontend
from backend.models import db  # ‚úÖ Evitar conflictos en importaciones
from backend.models.mascota import Mascota
from backend.services.mascota_service import agregar_mascota, obtener_mascotas

# ‚úÖ Configurar logging para auditor√≠a completa
logging.basicConfig(
    level=logging.DEBUG,
    format="%(asctime)s - %(levelname)s - %(message)s",
    handlers=[
        logging.FileHandler("backend/logs/funkelin_routes.log"),
        logging.StreamHandler()
    ]
)

# ‚úÖ Definir el blueprint con un prefijo estructurado
logging.debug("Inicializando Blueprint para mascotas")  # DEBUG
mascotas_bp = Blueprint("mascotas", __name__, url_prefix="/api/mascotas")
CORS(mascotas_bp, resources={r"/api/*": {"origins": "*"}})  # ‚úÖ Evita restricciones innecesarias

# ‚úÖ Ruta de prueba
@mascotas_bp.route("/test", methods=["GET"])
def test():
    """Ruta de prueba para verificar que el backend est√° activo."""
    logging.info("‚úÖ Endpoint `/test` ejecutado correctamente")  # INFO
    return jsonify({"mensaje": "Funkelin backend activo üöÄ"}), 200

# ‚úÖ Ruta para obtener la lista de todas las mascotas con manejo de errores
@mascotas_bp.route("/", methods=["GET"])
def get_mascotas():
    """Retorna la lista de mascotas registradas con manejo de errores."""
    logging.debug("Ejecutando `get_mascotas()`")  # DEBUG
    try:
        mascotas = obtener_mascotas()
        assert isinstance(mascotas, list), "Error: La respuesta debe ser una lista."
        logging.info(f"‚úÖ Mascotas obtenidas exitosamente ({len(mascotas)} registros)")  # INFO
        return jsonify(mascotas), 200
    except AssertionError as ae:
        logging.error(f"‚ö† Error en `get_mascotas()`: {str(ae)}")  # ERROR
        return jsonify({"error": f"Error interno de validaci√≥n: {str(ae)}"}), 500
    except Exception as e:
        db.session.rollback()
        logging.error(f"‚ö† Error cr√≠tico en `get_mascotas()`: {str(e)}")  # ERROR
        return jsonify({"error": f"Error al obtener mascotas: {str(e)}"}), 500

# ‚úÖ Ruta para agregar una nueva mascota con validaciones defensivas
@mascotas_bp.route("/", methods=["POST"])
def post_mascota():
    """Agrega una nueva mascota al sistema con validaciones estrictas."""
    logging.debug("Ejecutando `post_mascota()`")  # DEBUG
    try:
        data = request.get_json()
        if not data:
            logging.warning("‚ö† Intento de POST sin datos")  # WARNING
            return jsonify({"error": "No se recibi√≥ ning√∫n dato."}), 400

        # ‚úÖ Validaciones de entrada con sanitizaci√≥n
        nombre = data.get("nombre", "").strip()
        especie = data.get("especie", "").strip()
        edad = data.get("edad")

        try:
            edad = int(edad)
        except ValueError:
            logging.warning("‚ö† Edad inv√°lida en `post_mascota()`")  # WARNING
            return jsonify({"error": "Edad debe ser un n√∫mero entero v√°lido."}), 400

        if not (nombre and 2 <= len(nombre) <= 50):
            logging.warning(f"‚ö† Nombre inv√°lido: {nombre}")  # WARNING
            return jsonify({"error": "El nombre debe tener entre 2 y 50 caracteres."}), 400
        if especie not in ["Perro", "Gato", "Ave", "Otro"]:
            logging.warning(f"‚ö† Especie no v√°lida: {especie}")  # WARNING
            return jsonify({"error": "Tipo de mascota no v√°lido."}), 400
        if not (isinstance(edad, int) and edad > 0):
            logging.warning(f"‚ö† Edad inv√°lida: {edad}")  # WARNING
            return jsonify({"error": "Edad debe ser un n√∫mero entero positivo."}), 400

        # ‚úÖ Generar la mascota con programaci√≥n defensiva
        nueva_mascota = agregar_mascota(nombre, especie, edad)
        if nueva_mascota is None:
            raise ValueError("Error: La mascota no se cre√≥ correctamente.")

        logging.info(f"‚úÖ Mascota agregada: {nueva_mascota.to_dict()}")  # INFO
        return jsonify(nueva_mascota.to_dict()), 201
    except (AssertionError, ValueError) as ae:
        logging.warning(f"‚ö† Validaci√≥n fallida en `post_mascota()`: {str(ae)}")  # WARNING
        return jsonify({"error": f"Error de validaci√≥n: {str(ae)}"}), 400
    except Exception as e:
        db.session.rollback()
        logging.error(f"‚ö† Error cr√≠tico en `post_mascota()`: {str(e)}")  # ERROR
        return jsonify({"error": f"Error interno al agregar mascota: {str(e)}"}), 500
